# MyBatis体系结构与工作原理

## Mybatis的工作流程

![image-20220226164152028](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226164152028.png)

1.解析配置文件

2.创建工厂类

3.创建会话

4.会话操作数据库

## jar包结构

![image-20220226164605234](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226164605234.png)

## Mybatis的架构分层

1.提供给应用使用：接口层

2.处理数据库操作：核心层

3.支持工作：基础层

![image-20220226164841501](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226164841501.png)

## Mybatis缓存

![image-20220226172013267](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226172013267.png)



![image-20220226172036057](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226172036057.png)

所有的缓存实现类总体上可分为三类：基本缓存、淘汰算法缓存、装饰器缓存。

![image-20220226172152255](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226172152255.png)

![image-20220226172205917](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226172205917.png)

### 一级缓存工作位置与维护对象

> 一级缓存是基于sqlsession的缓存，会话是无法共享的。不同的一级会话对数据修改会产生脏数据。


![image-20220226171208971](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226171208971.png)

### 二级缓存

**作用域：namespace**

**二级缓存应该工作在一级缓存之前。**

#### 二级缓存工作位置与维护对象

![image-20220226174041517](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226174041517.png)

#### 开启二级缓存的方法

第一步：在mybatis-config.xml文件配置

```xml
<setting name="cacheEnabled" value="true"/>
```

第二步：在 Mapper.xml 中配置标签

```xml
<!-- 声明这个 namespace 使用二级缓存 -->
<cache type="org.apache.ibatis.cache.impl.PerpetualCache"
    size="1024" <!--最多缓存对象个数，默认 1024-->
    eviction="LRU"  <!--回收策略-->
    flushInterval="120000" <!--自动刷新时间 ms，未配置时只有调用时刷新-->
    readOnly="false"/> <!--默认是 false（安全），改为 true 可读写时，对象必须支持序列化 -->
```

#### Cache属性讲解

![image-20220226174542289](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226174542289.png)

![image-20220226174557541](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20220226174557541.png)

#### 二级缓存的关闭

我们可以在单个 Statement ID 上显式关闭二级缓存（默认是 true）

```xml
<select id="selectBlog" resultMap="BaseResultMap" useCache="false>
```

## Mybatis源码解析

二级缓存的key是什么？怎么命中缓存？

参数+mapper
