# 一步一步手绘Spring IOC运行时序图

## Spring IOC 基础

### 对象和对象的关系怎么表示？

xml/properties

### 描述对象关系的文件存放在那里？

classpath/network/filesystem/servletContext

### 如何统一配置文件的标准

BeanDefintion

### 如何对不同的配置文件进行解析

`策略模式`

### BeanFactory

![image-20211121165320352](https://gitee.com/forge-logic/images-lib/raw/master/img/1637484819.jpg)

### BeanDefinition

![1637485183](https://gitee.com/forge-logic/images-lib/raw/master/img/1637485183.jpg)

### BeanDefinitionReader

![1637485291](https://gitee.com/forge-logic/images-lib/raw/master/img/1637485291.jpg)

## Spring IOC容器初始化

### Spring IOC 初始化三部曲

![1637485443(1)](https://gitee.com/forge-logic/images-lib/raw/master/img/1637485443(1).jpg)

![1637485587(1)](https://gitee.com/forge-logic/images-lib/raw/master/img/1637485587(1).jpg)

### 阅读开始

```java
public class MainTest {
    public static void main(String[] args) {
        ApplicationContext context = new ClassPathXmlApplicationContext("application.xml");
    }
}
// 从ClassPathXmlApplicationContext开始
```

### 核心方法-refresh()

```java
	public void refresh() throws BeansException, IllegalStateException {
		synchronized (this.startupShutdownMonitor) {
			// Prepare this context for refreshing.
			//1、调用容器准备刷新的方法，获取容器的当时时间，同时给容器设置同步标识
			prepareRefresh();

			// Tell the subclass to refresh the internal bean factory.
			//2、告诉子类启动refreshBeanFactory()方法，Bean定义资源文件的载入从
			//子类的refreshBeanFactory()方法启动
			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

			// Prepare the bean factory for use in this context.
			//3、为BeanFactory配置容器特性，例如类加载器、事件处理器等
			prepareBeanFactory(beanFactory);

			try {
				// Allows post-processing of the bean factory in context subclasses.
				//4、为容器的某些子类指定特殊的BeanPost事件处理器
				postProcessBeanFactory(beanFactory);

				// Invoke factory processors registered as beans in the context.
				//5、调用所有注册的BeanFactoryPostProcessor的Bean
				invokeBeanFactoryPostProcessors(beanFactory);

				// Register bean processors that intercept bean creation.
				//6、为BeanFactory注册BeanPost事件处理器.
				//BeanPostProcessor是Bean后置处理器，用于监听容器触发的事件
				registerBeanPostProcessors(beanFactory);

				// Initialize message source for this context.
				//7、初始化信息源，和国际化相关.
				initMessageSource();

				// Initialize event multicaster for this context.
				//8、初始化容器事件传播器.
				initApplicationEventMulticaster();

				// Initialize other special beans in specific context subclasses.
				//9、调用子类的某些特殊Bean初始化方法
				onRefresh();

				// Check for listener beans and register them.
				//10、为事件传播器注册事件监听器.
				registerListeners();

				// Instantiate all remaining (non-lazy-init) singletons.
				//11、初始化所有剩余的单例Bean
				finishBeanFactoryInitialization(beanFactory);

				// Last step: publish corresponding event.
				//12、初始化容器的生命周期事件处理器，并发布容器的生命周期事件
				finishRefresh();
			}

			catch (BeansException ex) {
				if (logger.isWarnEnabled()) {
					logger.warn("Exception encountered during context initialization - " +
							"cancelling refresh attempt: " + ex);
				}

				// Destroy already created singletons to avoid dangling resources.
				//13、销毁已创建的Bean
				destroyBeans();

				// Reset 'active' flag.
				//14、取消refresh操作，重置容器的同步标识。
				cancelRefresh(ex);

				// Propagate exception to caller.
				throw ex;
			}

			finally {
				// Reset common introspection caches in Spring's core, since we
				// might not ever need metadata for singleton beans anymore...
				//15、重设公共缓存
				resetCommonCaches();
			}
		}
	}
```



![image-20211207001057460](https://gitee.com/forge-logic/images-lib/raw/master/img/image-20211207001057460.png)

![未命名绘图](https://gitee.com/forge-logic/images-lib/raw/master/img/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.png)
